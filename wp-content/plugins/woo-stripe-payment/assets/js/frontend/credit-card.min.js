!function(r,t){function e(){t.BaseGateway.call(this,wc_stripe_credit_card_params),t.CheckoutGateway.call(this),window.addEventListener("hashchange",this.hashchange.bind(this)),(t.credit_card=this).confirmedSetupIntent=!1,this.has3DSecureParams(),this.handle_create_account_change()}var i={focus:"focused",empty:"empty",invalid:"invalid"};(e.prototype=r.extend({},t.BaseGateway.prototype,t.CheckoutGateway.prototype)).mappings={cardNumber:"#stripe-card-number",cardExpiry:"#stripe-exp",cardCvc:"#stripe-cvv"},e.prototype.initialize=function(){r(document.body).on("click","#place_order",this.place_order.bind(this)),r(document.body).on("change","#createaccount",this.handle_create_account_change.bind(this)),this.setup_card(),this.can_create_setup_intent()&&this.create_setup_intent()},e.prototype.setup_card=function(){var t;this.is_custom_form()?(t=r.extend(!0,{classes:i},this.params.cardOptions),["cardNumber","cardExpiry","cardCvc"].forEach(function(e){this[e]=this.elements.create(e,r.extend(!0,{},t,this.params.customFieldOptions[e]))}.bind(this)),this.cardNumber.on("change",this.card_number_change.bind(this)),this.cardNumber.on("change",this.on_input_change.bind(this)),this.cardExpiry.on("change",this.on_input_change.bind(this)),this.cardCvc.on("change",this.on_input_change.bind(this)),this.fields.required("billing_postcode")&&""!==this.fields.get("billing_postcode")&&0<r("#stripe-postal-code").length&&(r("#stripe-postal-code").val(this.fields.get("billing_postcode")),this.validate_postal_field()),r(document.body).on("change","#billing_postcode",function(e){var t=r("#billing_postcode").val();r("#stripe-postal-code").val(t).trigger("keyup")}.bind(this))):(this.card=this.elements.create("card",r.extend(!0,{},{value:{postalCode:this.fields.get("billing_postcode","")},hidePostalCode:this.fields.required("billing_postcode"),iconStyle:"default"},this.params.cardOptions)),r(document.body).on("change","#billing_postcode",function(e){this.card&&this.card.update({value:r("#billing_postcode").val()})}.bind(this))),setInterval(this.create_card_element.bind(this),2e3)},e.prototype.validate_postal_field=function(){var e,t;r("#billing_postcode").length&&r("#stripe-postal-code").length?this.params.postal_regex[this.fields.get("billing_country")]?(t=this.params.postal_regex[this.fields.get("billing_country")],e=r("#stripe-postal-code").val(),t=new RegExp(t,"i"),""!==e?null!==t.exec(e)?r("#stripe-postal-code").addClass("StripeElement--complete").removeClass("invalid"):r("#stripe-postal-code").removeClass("StripeElement--complete").addClass("invalid"):r("#stripe-postal-code").removeClass("StripeElement--complete").removeClass("invalid")):0!=r("#stripe-postal-code").val()?r("#stripe-postal-code").addClass("StripeElement--complete"):r("#stripe-postal-code").removeClass("StripeElement--complete"):r("#stripe-postal-code").length&&(""!=r("#stripe-postal-code").val()?r("#stripe-postal-code").addClass("StripeElement--complete"):r("#stripe-postal-code").removeClass("StripeElement--complete"))},e.prototype.create_card_element=function(){this.is_custom_form()?r("#wc-stripe-cc-custom-form").length&&0==r("#wc-stripe-cc-custom-form").find("iframe").length&&(r(this.mappings.cardNumber).length&&(this.cardNumber.mount(this.mappings.cardNumber),r(this.mappings.cardNumber).prepend(this.params.html.card_brand)),r(this.mappings.cardExpiry).length&&this.cardExpiry.mount(this.mappings.cardExpiry),r(this.mappings.cardCvc).length&&this.cardCvc.mount(this.mappings.cardCvc),r("#stripe-postal-code").length&&(r("#stripe-postal-code, .postalCode").on("focus",function(e){r("#stripe-postal-code").addClass("focused")}.bind(this)),r("#stripe-postal-code, .postalCode").on("blur",function(e){r("#stripe-postal-code").removeClass("focused").trigger("keyup")}.bind(this)),r("#stripe-postal-code").on("keyup",function(e){0==r("#stripe-postal-code").val()?r("#stripe-postal-code").addClass("empty"):r("#stripe-postal-code").removeClass("empty")}.bind(this)),r("#stripe-postal-code").on("change",this.validate_postal_field.bind(this)),r("#stripe-postal-code").trigger("change"))):r("#wc-stripe-card-element").length&&0==r("#wc-stripe-card-element").find("iframe").length&&(this.card.unmount(),this.card.mount("#wc-stripe-card-element"),this.card.update({value:{postalCode:this.fields.get("billing_postcode","")},hidePostalCode:this.fields.required("billing_postcode")})),r(this.container).outerWidth(!0)<450?r(this.container).addClass("stripe-small-container"):r(this.container).removeClass("stripe-small-container")},e.prototype.place_order=function(e){if(this.is_gateway_selected())if(this.can_create_setup_intent()&&!this.is_saved_method_selected()&&this.checkout_fields_valid()){if(e.preventDefault(),this.confirmedSetupIntent)return this.on_setup_intent_received(this.confirmedSetupIntent.payment_method);this.stripe.confirmCardSetup(this.client_secret,{payment_method:{card:this.is_custom_form()?this.cardNumber:this.card,billing_details:function(){return this.is_current_page("checkout")?this.get_billing_details():r.extend({},this.is_custom_form()?{address:{postal_code:r("#stripe-postal-code").val()}}:{})}.bind(this)()}}).then(function(e){e.error?this.submit_error(e.error):(this.confirmedSetupIntent=e.setupIntent,this.on_setup_intent_received(e.setupIntent.payment_method))}.bind(this))}else this.payment_token_received||this.is_saved_method_selected()||(e.preventDefault(),this.checkout_fields_valid()&&this.stripe.createPaymentMethod({type:"card",card:this.is_custom_form()?this.cardNumber:this.card,billing_details:this.get_billing_details()}).then(function(e){if(e.error)return this.submit_error(e.error);this.on_token_received(e.paymentMethod)}.bind(this)))},e.prototype.checkout_place_order=function(){return this.is_saved_method_selected()||this.payment_token_received?t.CheckoutGateway.prototype.checkout_place_order.apply(this,arguments):(this.place_order.apply(this,arguments),!1)},e.prototype.create_setup_intent=function(){return new Promise(function(t,e){r.when(r.ajax({method:"POST",dataType:"json",url:this.params.routes.setup_intent,beforeSend:this.ajax_before_send.bind(this)})).done(function(e){e.code?this.submit_error(e.message):this.client_secret=e.intent.client_secret,t(e)}.bind(this)).fail(function(e,t,i){this.submit_error(i)}.bind(this))}.bind(this))},e.prototype.on_token_received=function(e){this.payment_token_received=!0,this.set_nonce(e.id),this.get_form().submit()},e.prototype.on_setup_intent_received=function(e){this.payment_token_received=!0,this.set_nonce(e),this.get_form().submit()},e.prototype.updated_checkout=function(){this.create_card_element(),this.handle_create_account_change(),this.can_create_setup_intent()&&!this.client_secret&&this.create_setup_intent()},e.prototype.update_checkout=function(){this.clear_card_elements()},e.prototype.show_payment_button=function(){t.CheckoutGateway.prototype.show_place_order.apply(this,arguments)},e.prototype.hide_place_order=function(){},e.prototype.is_custom_form=function(){return"1"===this.params.custom_form},e.prototype.get_postal_code=function(){return this.is_custom_form()&&0<r("#stripe-postal-code").length?r("#stripe-postal-code").val():this.fields.get("billing_postcode",null)},e.prototype.card_number_change=function(e){"unknown"===e.brand?r("#wc-stripe-card").removeClass("active"):r("#wc-stripe-card").addClass("active"),r("#wc-stripe-card").attr("src",this.params.cards[e.brand])},e.prototype.on_input_change=function(e){if(e.complete){var t=r("#wc-stripe-cc-custom-form").find(".StripeElement, #stripe-postal-code"),i=[];t.each(function(e,t){i.push("#"+r(t).attr("id"))}.bind(this));var e=this.mappings[e.elementType],s=i.indexOf(e);if("undefined"!=typeof i[s+1])if("#stripe-postal-code"===i[s+1])document.getElementById("stripe-postal-code").focus();else for(var o in this.mappings)this.mappings[o]===i[s+1]&&this[o].focus()}},e.prototype.clear_card_elements=function(){for(var e=["cardNumber","cardExpiry","cardCvc"],t=0;t<e.length;t++)this[e[t]]&&this[e[t]].clear()},e.prototype.checkout_error=function(){this.is_gateway_selected()&&(this.payment_token_received=!1),t.CheckoutGateway.prototype.checkout_error.call(this)},e.prototype.get_billing_details=function(){var e=t.BaseGateway.prototype.get_billing_details.call(this);return e.address.postal_code=this.get_postal_code(),e},e.prototype.can_create_setup_intent=function(){return this.is_add_payment_method_page()||this.is_change_payment_method()||this.is_current_page("checkout")&&this.cart_contains_subscription()&&this.get_gateway_data()&&0==this.get_total_price_cents()||this.is_current_page("checkout")&&"undefined"!=typeof wc_stripe_preorder_exists||this.is_current_page("order_pay")&&"pre_order"in this.get_gateway_data()&&!0===this.get_gateway_data().pre_order||this.is_current_page("product")&&0==this.get_total_price_cents()},e.prototype.handle_create_account_change=function(){r("#createaccount").length&&(r("#createaccount").is(":checked")?r(".wc-stripe-save-source").show():r(".wc-stripe-save-source").hide())},new e}(jQuery,window.wc_stripe);